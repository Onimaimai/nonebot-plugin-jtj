# 机厅插件文档

## 项目简介

机厅(JTJ)插件是一个用于查询和更新机厅人数的QQ机器人插件，基于nonebot2框架开发。该插件允许用户订阅、查询和更新各个机厅的实时人数信息，并提供机厅简称管理、附近机厅查询等功能。

## 功能特性

- **机厅查询**：根据ID、简称或城市查询机厅信息
- **订阅管理**：订阅/退订指定机厅或整个城市的机厅
- **人数更新**：通过简称快速更新机厅人数
- **简称管理**：为机厅添加、删除和查看简称
- **附近机厅**：基于位置查询附近的机厅
- **机厅地图**：生成附近机厅的地图可视化
- **机厅申请**：用户可申请添加新机厅，超级用户审核
- **贡献排行**：显示每日上报人数的用户排行榜
- **静默模式**：控制机器人是否主动回复消息

## 命令列表

### 基础查询命令
- `jtj <城市/简称/id>` - 查询指定机厅
- `jtj` - 查询本群订阅的机厅
- `附近机厅` - 查询附近机厅
- `机厅地图 [半径]` - 生成附近机厅地图（默认半径为4）

### 订阅管理命令
- `订阅机厅 <id1> [id2]...` - 订阅多个机厅(空格分隔)
- `退订机厅 <id1> [id2]...` - 退订多个机厅(空格分隔)
- `订阅城市 <城市>` - 订阅指定城市的所有机厅
- `退订城市 <城市>` - 退订指定城市的所有机厅

### 简称管理命令
- `添加简称 <id> <简称>` - 为机厅添加简称
- `删除简称 <id> <简称>` - 删除机厅的简称
- `查看简称 [id]` - 查看所有简称或指定机厅的简称

### 人数更新命令
- `<简称><数字>` - 直接更新人数(如:万达10)
- `<简称>+<数字>` - 增加人数(如:万达+2)
- `<简称>-<数字>` - 减少人数(如:万达-1)
- `<简称>j` 或 `<简称>几` - 查询该简称对应的机厅人数

### 管理员命令
- `申请机厅 <机厅名称> <城市>` - 申请添加新机厅
- `添加机厅` - 通过位置添加机厅
- `审核机厅` - 超级用户审核新添加机厅
- `清空审核机厅` - 超级用户清空待审核机厅列表
- `机厅静默 [开/关]` - 控制机器人是否主动回复消息

### 其他功能
- `jt贡献榜` - 查看今日机厅人数上报排行榜

## 项目结构

```
jtj/
├── __init__.py         # 主插件文件
└── data/              # 数据存储目录
    ├── aliases.json      # 简称映射数据
    ├── rate_limit.json   # 速率限制数据
    ├── report_stats.json # 上报统计数据
    ├── shop_cache.json   # 机厅缓存数据
    ├── silent_mode.json  # 静默模式配置
    └── subscriptions.json # 订阅数据
```

## 数据说明

### 简称映射 (aliases.json)
存储机厅ID与简称的映射关系，支持一个简称对应多个机厅，也支持一个机厅有多个简称。

### 订阅数据 (subscriptions.json)
存储各群组订阅的机厅信息，包括机厅ID和最后记录的人数。

### 机厅缓存 (shop_cache.json)
缓存从API获取的机厅信息，减少API调用次数，提高响应速度。

### 速率限制 (rate_limit.json)
存储用户的操作频率限制信息，防止恶意刷榜。

### 上报统计 (report_stats.json)
记录用户上报机厅人数的统计信息，用于生成贡献榜。

### 机厅静默 (silent_mode.json)
存储开启静默模式的群组ID列表。

## API接口

插件使用以下API接口获取和更新机厅数据：

- 机厅查询：`/maihere/query/getData_solo.php`
- 城市机厅查询：`/maihere/query/getData_city.php`
- 城市信息查询：`/maihere/query/queryCity.php`
- 人数更新：`/maihere/upload/uploadData.php`
- 附近机厅查询：`/maihere/location/distance.php`
- 机厅地图生成：`/maihere/location/pic.php`
- 添加机厅：`/maihere/location/add.php`
- 审核机厅：`/maihere/location/pass.php`
- 清空审核列表：`/maihere/location/clear_review.php`

## 防刷榜机制

为防止恶意上报人数，插件实现了速率限制机制：

- 1分钟内最多允许3次上报操作
- 超过限制将封禁用户300秒（5分钟）
- 单次上报人数上限为50人

## 注意事项

1. 插件需要配置正确的API_URL和API_KEY才能正常工作
2. 超级用户ID需要在代码中配置，用于审核机厅等管理操作
3. 插件会定期更新缓存数据，确保信息的时效性
4. 静默模式下，机器人不会主动回复人数消息，但可通过@机器人进行查询

## 安装与配置

1. 将插件文件放置在nonebot2的插件目录下
2. 安装必要的依赖：`pip install nonebot2 httpx`
3. 配置API_URL和API_KEY
4. 设置超级用户ID
5. 启动nonebot2机器人

